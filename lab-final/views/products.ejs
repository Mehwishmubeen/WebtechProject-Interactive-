<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Products</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .products-page-wrapper { padding: 2rem 5vw; }
    .products-page-header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
    .filter-form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .filter-form label { display: flex; flex-direction: column; font-size: 0.9rem; gap: 0.4rem; }
    .filter-form input, .filter-form select { padding: 0.5rem; min-width: 180px; }
    .filter-form button { padding: 0.6rem 1.4rem; border: none; background: #000; color: #fff; cursor: pointer; }
    .filter-form button:hover { background: #333; }
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1.5rem; }
    .product-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; box-shadow: 0 12px 25px -22px rgba(0,0,0,0.45); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 18px 35px -20px rgba(0,0,0,0.45); }
    .product-card img { width: 100%; height: 180px; object-fit: cover; }
    .product-card-body { padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .product-card-category { font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; color: #777; }
    .product-card-price { font-weight: 600; font-size: 1.1rem; }
    .product-card-description { font-size: 0.9rem; color: #555; }
    .product-card-actions { margin-top: auto; }
    .add-to-cart-btn { display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.55rem 1.1rem; border: none; border-radius: 999px; background: #0b5ed7; color: #fff; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s ease; text-decoration: none; }
    .add-to-cart-btn:hover { background: #08429c; }
    .add-to-cart-btn i { font-size: 0.95rem; }
    .empty-state { text-align: center; padding: 3rem 0; color: #666; font-size: 1.1rem; }
    .pagination { margin-top: 2rem; display: flex; gap: 0.75rem; justify-content: center; }
    .pagination a { padding: 0.6rem 1rem; border: 1px solid #ccc; color: #333; text-decoration: none; border-radius: 4px; }
    .pagination a.active { background: #000; color: #fff; border-color: #000; }
    .pagination a:hover { border-color: #000; }
    @media (max-width: 600px) {
      .filter-form { flex-direction: column; align-items: stretch; }
      .filter-form input, .filter-form select { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <%- include('partials/header') %>
    <div class="navbar">
      <span class="logo">
        <a href="/"> <img id="img" src="/retina-interactive.png" alt="BeInteractive"></a>
      </span>
      <ul class="menu-bar">
        <a href="/">HOME</a>
        <a href="/products" class="active">PRODUCTS</a>
        <a href="#">OFFER</a>
        <a href="#">COMPANY</a>
        <a href="#">PORTFOLIO</a>
        <a href="/checkout">CHECKOUT</a>
      </ul>
    </div>
  </div>

  <main class="products-page-wrapper">
    <div class="products-page-header">
      <h1>Browse Our Products</h1>
      <p>Use filters to explore categories and price ranges sourced live from MongoDB.</p>
      <form class="filter-form" method="get" action="/products">
        <label>
          Category
          <select name="category">
            <option value="" <%= !query.category ? "selected" : "" %>>All Categories</option>
            <option value="Electronics" <%= query.category === "Electronics" ? "selected" : "" %>>Electronics</option>
            <option value="Clothing" <%= query.category === "Clothing" ? "selected" : "" %>>Clothing</option>
            <option value="Accessories" <%= query.category === "Accessories" ? "selected" : "" %>>Accessories</option>
            <option value="Home" <%= query.category === "Home" ? "selected" : "" %>>Home</option>
          </select>
        </label>
        <label>
          Min Price
          <input type="number" name="minPrice" placeholder="0" value="<%= query.minPrice || "" %>" min="0">
        </label>
        <label>
          Max Price
          <input type="number" name="maxPrice" placeholder="1000" value="<%= query.maxPrice || "" %>" min="0">
        </label>
        <input type="hidden" name="limit" value="<%= query.limit || 10 %>">
        <button type="submit">Apply Filters</button>
      </form>
    </div>

    <% if (!products.length) { %>
      <div class="empty-state">
        <p>No products matched your filters. Try adjusting the options.</p>
      </div>
    <% } else { %>
      <div class="products-grid">
        <% products.forEach(product => {
          const rawImage = (product.image || "").trim();
          const placeholder = "https://via.placeholder.com/400x300?text=Image+Unavailable";
          let imagePath = placeholder;
          let altImagePath = "";

          if (rawImage) {
            if (/^https?:\/\//i.test(rawImage)) {
              imagePath = rawImage;
            } else {
              let sanitized = rawImage
                .replace(/\\/g, "/")
                .replace(/^public\//i, "")
                .trim();

              sanitized = sanitized.replace(/^\/+/, "");

              if (sanitized) {
                imagePath = `/${sanitized}`;

                if (!sanitized.includes("/")) {
                  altImagePath = `/images/${sanitized}`;
                }
              }
            }
          }
        %>
          <article class="product-card">
            <img src="<%= imagePath %>" alt="<%= product.name %>"
                 <%= altImagePath ? `data-alt-src="${altImagePath}"` : "" %>
                 onerror="if(!this.dataset.altTried && this.dataset.altSrc){this.dataset.altTried='1';this.src=this.dataset.altSrc;}else{this.onerror=null;this.src='<%= placeholder %>';}">
            <div class="product-card-body">
              <span class="product-card-category"><%= product.category %></span>
              <h3><%= product.name %></h3>
              <span class="product-card-price">$<%= product.price.toFixed(2) %></span>
              <p class="product-card-description"><%= product.description %></p>
              <div class="product-card-actions">
                <a
                  class="add-to-cart-btn js-add-to-cart"
                  href="/checkout"
                  data-id="<%= product._id %>"
                  data-name="<%= product.name %>"
                  data-price="<%= product.price %>"
                  data-image="<%= imagePath %>"
                >
                  <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                  <span>Add to Cart</span>
                </a>
              </div>
            </div>
          </article>
        <% }) %>
      </div>
    <% } %>

    <div class="pagination">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <% const search = new URLSearchParams({
          page: i,
          limit: query.limit || 10,
          category: query.category || "",
          minPrice: query.minPrice || "",
          maxPrice: query.maxPrice || ""
        }); %>
        <a href="/products?<%= search.toString() %>" class="<%= i === currentPage ? 'active' : '' %>"><%= i %></a>
      <% } %>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script>
    (function () {
      const STORAGE_KEY = "cartItems";

      function loadCart() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) return [];
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch (err) {
          console.warn("Cart parse failed", err);
          return [];
        }
      }

      function saveCart(items) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      }

      function addItemToCart(item) {
        const cart = loadCart();
        const existing = cart.find((entry) => entry.id === item.id);

        if (existing) {
          existing.quantity += item.quantity;
        } else {
          cart.push(item);
        }

        saveCart(cart);
      }

      function bindAddToCartButtons() {
        const buttons = document.querySelectorAll(".js-add-to-cart");
        buttons.forEach((button) => {
          button.addEventListener("click", (event) => {
            event.preventDefault();

            const item = {
              id: button.dataset.id,
              name: button.dataset.name,
              price: Number(button.dataset.price) || 0,
              image: button.dataset.image || "",
              quantity: 1,
            };

            addItemToCart(item);

            window.dispatchEvent(new Event("cart:updated"));
            window.location.href = button.href;
          });
        });
      }

      document.addEventListener("DOMContentLoaded", bindAddToCartButtons);
    })();
  </script>
</body>
</html>
