<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout Page</title>
  <link rel="stylesheet" href="/css/checkout.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-T3R2P+PCbM6X64hYpG9u4kZfD2tD/txG2hGrW+Jm6nY3c8U1tB0A6i3DsHz7J0v4+lz1LZkLfHhG3r+F4a0A0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

  <%- include('partials/header') %>

  <div class="container my-4">
    <form id="checkoutForm">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title border-bottom pb-2">Customer Info</h5>

              <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" id="name" class="form-control" placeholder="John Doe">
                <div class="invalid-feedback">Name must be at least 3 characters.</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-control" placeholder="john@example.com">
                <div class="invalid-feedback">Enter a valid email.</div>
              </div>

              <button class="btn btn-primary w-100" type="submit">Place Order</button>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title border-bottom pb-2">Order Summary</h5>
              <p class="text-muted small mb-3" id="orderSummaryEmpty">Your cart is empty. Return to the product catalog to add items.</p>
              <div id="orderSummaryList" class="order-summary-list"></div>
              <div class="order-summary-totals pt-3 mt-3 border-top">
                <div class="d-flex justify-content-between mb-2">
                  <span id="summaryCount" class="text-muted">0 items</span>
                  <span id="summarySubtotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between">
                  <strong>Total</strong>
                  <strong id="summaryTotal">$0.00</strong>
                </div>
                <div class="mt-3 text-end">
                  <button type="button" id="clearCartBtn" class="btn btn-outline-danger btn-sm">Clear Cart</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <%- include('partials/footer') %>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="/js/checkout.js"></script>
<script>
  (function () {
    const STORAGE_KEY = "cartItems";
    const summaryList = document.getElementById("orderSummaryList");
    const summaryEmpty = document.getElementById("orderSummaryEmpty");
    const summarySubtotal = document.getElementById("summarySubtotal");
    const summaryTotal = document.getElementById("summaryTotal");
    const summaryCount = document.getElementById("summaryCount");
    const clearCartBtn = document.getElementById("clearCartBtn");

    if (!summaryList || !summaryEmpty || !summarySubtotal || !summaryTotal || !summaryCount) {
      return;
    }

    function loadCart() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.warn("Cart load failed", err);
        return [];
      }
    }

    function saveCart(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function formatCurrency(value) {
      return `$${value.toFixed(2)}`;
    }

    function renderSummary() {
      const items = loadCart();
      summaryList.innerHTML = "";

      if (!items.length) {
        summaryEmpty.classList.remove("d-none");
        summarySubtotal.textContent = "$0.00";
        summaryTotal.textContent = "$0.00";
        summaryCount.textContent = "0 items";
        return;
      }

      summaryEmpty.classList.add("d-none");

      let subtotal = 0;
      let totalItems = 0;

      items.forEach((item) => {
        const quantity = Number(item.quantity) || 0;
        const price = Number(item.price) || 0;
        const lineTotal = quantity * price;
        subtotal += lineTotal;
        totalItems += quantity;

        const wrapper = document.createElement("div");
        wrapper.className = "order-summary-item d-flex align-items-start gap-3 mb-3";

        const image = document.createElement("img");
        image.src = item.image || "https://via.placeholder.com/80?text=No+Image";
        image.alt = item.name || "Cart item";
        image.className = "order-summary-thumb";

        const details = document.createElement("div");
        details.className = "flex-grow-1";

        const name = document.createElement("h6");
        name.className = "mb-1";
        name.textContent = item.name || "Unnamed Product";

        const meta = document.createElement("p");
        meta.className = "text-muted small mb-0";
        meta.textContent = `${quantity} Ã— ${formatCurrency(price)}`;

        const controls = document.createElement("div");
        controls.className = "order-summary-controls";

        const minusBtn = document.createElement("button");
        minusBtn.type = "button";
        minusBtn.className = "order-summary-btn";
        minusBtn.dataset.action = "decrease";
        minusBtn.dataset.id = item.id;
        minusBtn.textContent = "-";
        minusBtn.setAttribute("aria-label", "Decrease quantity");

        const qtyDisplay = document.createElement("span");
        qtyDisplay.className = "order-summary-qty";
        qtyDisplay.textContent = quantity;

        const plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.className = "order-summary-btn";
        plusBtn.dataset.action = "increase";
        plusBtn.dataset.id = item.id;
        plusBtn.textContent = "+";
        plusBtn.setAttribute("aria-label", "Increase quantity");

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "order-summary-btn order-summary-remove";
        removeBtn.dataset.action = "remove";
        removeBtn.dataset.id = item.id;
        removeBtn.textContent = "ðŸ—‘";
        removeBtn.setAttribute("aria-label", "Remove item");

        controls.appendChild(minusBtn);
        controls.appendChild(qtyDisplay);
        controls.appendChild(plusBtn);
        controls.appendChild(removeBtn);

        const line = document.createElement("strong");
        line.className = "order-summary-line-total";
        line.textContent = formatCurrency(lineTotal);

        details.appendChild(name);
        details.appendChild(meta);
        details.appendChild(controls);

        wrapper.appendChild(image);
        wrapper.appendChild(details);
        wrapper.appendChild(line);

        summaryList.appendChild(wrapper);
      });

      summarySubtotal.textContent = formatCurrency(subtotal);
      summaryTotal.textContent = formatCurrency(subtotal);
      summaryCount.textContent = `${totalItems} ${totalItems === 1 ? "item" : "items"}`;
    }

    function modifyQuantity(id, delta) {
      const cart = loadCart();
      const index = cart.findIndex((entry) => entry.id === id);
      if (index === -1) return;

      const currentQuantity = Number(cart[index].quantity) || 0;
      const nextQuantity = currentQuantity + delta;

      if (nextQuantity <= 0) {
        cart.splice(index, 1);
      } else {
        cart[index].quantity = nextQuantity;
      }

      saveCart(cart);
      window.dispatchEvent(new Event("cart:updated"));
    }

    function removeItem(id) {
      const cart = loadCart().filter((entry) => entry.id !== id);
      saveCart(cart);
      window.dispatchEvent(new Event("cart:updated"));
    }

    function handleSummaryClick(event) {
      const button = event.target.closest("[data-action]");
      if (!button) return;

      const id = button.dataset.id;
      const action = button.dataset.action;
      if (!id || !action) return;

      if (action === "increase") {
        modifyQuantity(id, 1);
      } else if (action === "decrease") {
        modifyQuantity(id, -1);
      } else if (action === "remove") {
        removeItem(id);
      }
    }

    summaryList.addEventListener("click", handleSummaryClick);

    document.addEventListener("DOMContentLoaded", renderSummary);
    window.addEventListener("cart:updated", renderSummary);

    if (clearCartBtn) {
      clearCartBtn.addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        window.dispatchEvent(new Event("cart:updated"));
      });
    }
  })();
</script>
</body>
</html>
